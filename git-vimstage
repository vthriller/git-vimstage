#!/bin/sh
[ $# -ne 1 ] && {
	echo "Usage: git vimstage <file>"
	exit 1
}
DEDITOR=$(git config --get vimstage.editor || echo vimdiff)
set -e -x
current=$(mktemp --suffix=.vimstage)
(
	future=$(mktemp --suffix=.vimstage)
	(
		git show :./"$1" > "$current"
		cp "$current" "$future"
		"$DEDITOR" "$future" "$1"
		diff -u --label="./$1"{,} "$current" "$future" | git apply --cached
	)
	rm -f "$future"
)
rm -f "$current"
